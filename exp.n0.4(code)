import socket
import threading
import time
import sys
PORT = 4000
SERVER_HOST = '127.0.0.1'
BUFFER_SIZE = 1024
def tcp_chat_server():
    """Implements a simple TCP chat server in Python."""
    server_socket = None
    client_socket = None
    try:
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind((SERVER_HOST, PORT))
        server_socket.listen(1) 
        print(f"[Server] Server started on {SERVER_HOST}:{PORT}")
        client_socket, client_address = server_socket.accept()
        print(f"[Server] Client connected from {client_address}")
        while True:
            client_msg_bytes = client_socket.recv(BUFFER_SIZE)
            client_msg = client_msg_bytes.decode('utf-8').strip()

            if client_msg.lower() == "end":
                print("[Server] Client ended the chat.")
                break
            print(f"[Client Message]: {client_msg}")
            server_msg = input("[Server] Message to Client: ")
            client_socket.sendall(server_msg.encode('utf-8'))

            if server_msg.lower() == "end":
                print("[Server] Ending the chat.")
                break
    except Exception as e:
        print(f"[Server] An error occurred: {e}")
    finally:
        if client_socket:
            client_socket.close()
            print("[Server] Client socket closed.")
        if server_socket:
            server_socket.close()
            print("[Server] Server socket closed.")
        print("[Server] Connection closed.\n")

def tcp_chat_client():
    """Implements a simple TCP chat client in Python."""
    client_socket = None
    try:
        print("[Client] Trying to connect to server...")
        client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client_socket.connect((SERVER_HOST, PORT))
        print("[Client] Connected to server.")

        print("Type 'end' to quit the chat")

        while True:
            client_msg = input("[Client] Message to Server: ")
            client_socket.sendall(client_msg.encode('utf-8'))

            if client_msg.lower() == "end":
                print("[Client] Ending the chat.")
                break
            server_msg_bytes = client_socket.recv(BUFFER_SIZE)
            server_msg = server_msg_bytes.decode('utf-8').strip()
            print(f"[Server Message]: {server_msg}")

            if server_msg.lower() == "end":
                print("[Client] Server ended the chat.")
                break
    except Exception as e:
        print(f"[Client] An error occurred: {e}")
    finally:
        if client_socket:
            client_socket.close()
            print("[Client] Socket closed.\n")
print("--- Starting TCP Chat Demo ---")
server_thread = threading.Thread(target=tcp_chat_server)
server_thread.daemon = True 
server_thread.start()
time.sleep(1)
client_thread = threading.Thread(target=tcp_chat_client)
client_thread.daemon = True 
client_thread.start()
while server_thread.is_alive() or client_thread.is_alive():
    time.sleep(0.5)
print("--- TCP Chat Demo Finished ---")
