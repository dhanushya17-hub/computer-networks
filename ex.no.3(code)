import socket
import threading
import time

PORT = 4000
SERVER_HOST = '127.0.0.1'

def start_server():
    """Starts a simple Python server that handles one client connection."""
    sersock = None
    sock = None
    try:
        sersock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sersock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        sersock.bind((SERVER_HOST, PORT))
        sersock.listen(1) 
        print(f"[Server] Started: {sersock.getsockname()}")
        sock, addr = sersock.accept()
        print(f"[Server] Client Connected: {addr}")
        data_from_client = sock.recv(1024).decode('utf-8')
        print(f"[Server] Received: {data_from_client.strip()}")
        message_to_client = "Hello from server\n"
        sock.sendall(message_to_client.encode('utf-8'))
        print(f"[Server] Sent: {message_to_client.strip()}")

    except socket.error as se:
        print(f"[Server] Socket problem: {se}")
    except Exception as e:
        print(f"[Server] Couldn't start: {e}")
    finally:
        if sock:
            sock.close()
        if sersock:
            sersock.close()
        print("[Server] Connection closed.")

def start_client():
    """Starts a simple Python client that connects to the server."""
    sock = None
    try:
        print("[Client] Trying to connect")
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((SERVER_HOST, PORT))
        print(f"[Client] Connected to server: {sock.getpeername()}") 
        message_to_server = "Hi from client\n"
        sock.sendall(message_to_server.encode('utf-8'))
        print(f"[Client] Sent: {message_to_server.strip()}")
        data_from_server = sock.recv(1024).decode('utf-8')
        print(f"[Client] Received: {data_from_server.strip()}")

    except socket.error as se:
        print(f"[Client] Socket error: {se}")
    except Exception as e:
        print(f"[Client] General error: {e}")
    finally:
        if sock:
            sock.close()
        print("[Client] Connection closed.")

print("--- Starting Server and Client Demo ---")
server_thread = threading.Thread(target=start_server)
server_thread.start()
time.sleep(1) 
client_thread = threading.Thread(target=start_client)
client_thread.start()
client_thread.join()
server_thread.join()

print("--- Demo Finished ---")
